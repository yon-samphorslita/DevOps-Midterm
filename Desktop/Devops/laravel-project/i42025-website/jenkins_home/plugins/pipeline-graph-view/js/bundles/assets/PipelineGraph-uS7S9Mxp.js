import{j as t,T as E,s as F,n as I,r as x,d as T,l as _,R as z,G as J}from"./connections-D9dwIvBS.js";import{S as O,T as A,a as w,r as K}from"./timings-D3e1D_MJ.js";import{u as Q}from"./tree-api-16e_7KIy.js";function U({node:e,collapsed:a}){var u;const n=e.key;if(e.isPlaceholder){if(e.type==="counter"){const m=e,S=t.jsx("ol",{className:"pgv-node__counter-tooltip",children:m.stages.map(d=>t.jsx("li",{children:t.jsxs("a",{className:"jenkins-button jenkins-button--tertiary",href:document.head.dataset.rooturl+d.url,children:[t.jsx(O,{status:d.state,percentage:d.completePercent,skeleton:d.skeleton}),d.name,t.jsx("span",{style:{color:"var(--text-color-secondary)"},children:t.jsx(A,{ms:d.totalDurationMillis})})]})},d.id))});return t.jsx(w,{content:S,interactive:!0,appendTo:document.body,children:t.jsx("div",{style:{position:"absolute",top:e.y,left:e.x,translate:"-50% -50%"},className:"PWGx-pipeline-node",children:t.jsx("span",{className:"PWGx-pipeline-node-counter",children:m.stages.length})},n)})}return t.jsx("div",{style:{position:"absolute",top:e.y,left:e.x,translate:"-50% -50%"},className:"PWGx-pipeline-node",children:t.jsx("span",{className:"PWGx-pipeline-node-terminal"})},n)}const l=[],{title:o,state:f,url:i}=e.stage??{};l.push(t.jsx(O,{status:e.stage.state,percentage:e.stage.completePercent,skeleton:e.stage.skeleton},`icon-${e.id}`));const r=!e.isPlaceholder&&((u=e.stage)==null?void 0:u.state)!=="skipped"&&!e.stage.skeleton,c={key:n,style:{position:"absolute",top:e.y,left:e.x,translate:"-50% -50%"},className:"PWGx-pipeline-node PWGx-pipeline-node--"+f+" "+K(e.stage.state,e.stage.skeleton)};let h;return a&&(h=t.jsxs("div",{className:"pgv-node-tooltip",children:[t.jsx("div",{children:o}),t.jsx("div",{children:t.jsx(A,{ms:e.stage.totalDurationMillis})})]})),t.jsx(w,{content:h,children:t.jsxs("div",{...c,children:[l,r&&t.jsx("a",{href:document.head.dataset.rooturl+i,children:t.jsx("span",{className:"jenkins-visually-hidden",children:o})})]})})}function X({layout:e,nodeColumns:a,isStageSelected:n}){const{nodeRadius:l,connectorStrokeWidth:o}=e,f=Math.ceil(l+.5*o+1);let i;e:for(const c of a)for(const h of c.rows)for(const u of h)if(!u.isPlaceholder&&n(u.stage)){i=u;break e}if(!i)return null;const r=`translate(${i.x} ${i.y})`;return t.jsx("g",{className:"PWGx-pipeline-selection-highlight",transform:r,children:t.jsx("circle",{r:f,strokeWidth:o})},"selection-highlight")}function Y(e){return e.startsWith("Matrix -")?e.replace("Matrix - ","").split(",").map(a=>{const n=a.split("=");return{key:n[0].trim(),value:n[1].trim().replace(/'/g,"")}}):e}function Z(e){const a=Y(e.content);if(typeof a=="string")return t.jsx(t.Fragment,{children:t.jsx(w,{content:a,interactive:!0,followCursor:!0,children:e.children})});const n=t.jsx("table",{children:a.map((l,o)=>t.jsxs("tr",{children:[t.jsx("td",{children:l.key}),t.jsx("td",{children:l.value})]},o))});return t.jsx(t.Fragment,{children:t.jsx(w,{content:n,interactive:!0,children:e.children})})}function ee({details:e,layout:a,measuredHeight:n,isStageSelected:l,selectedStage:o}){var L;function f(P,W){if(P){const{children:k}=P;if(k&&W)for(const M of k){let p=M;for(;p;){if(p.id===W.id)return!0;p=p.nextSibling}}}return!1}const{nodeSpacingH:i,labelOffsetV:r,connectorStrokeWidth:c,ypStart:h}=a,u=i-c*2,m=h-r,S=Math.floor(u/-2),d={position:"absolute",width:u,maxHeight:m+"px",textAlign:"center",marginLeft:S},j=e.x,b=n-e.y+r,G={...d,bottom:b+"px",left:j+"px"},y=["PWGx-pipeline-big-label"];return(l(e.stage)||f(e.stage,o))&&y.push("selected"),e.stage&&e.stage.synthetic&&y.push("pgv-graph-node--synthetic"),(L=e.stage)!=null&&L.skeleton&&y.push("pgv-graph-node--skeleton"),e.node.id<0&&y.push("pgv-graph-node--skeleton"),t.jsx(E,{className:y.join(" "),style:G,children:e.text},e.key)}function te({details:e,layout:a,isStageSelected:n}){const{nodeSpacingH:l,nodeSpacingV:o,curveRadius:f,connectorStrokeWidth:i,nodeRadius:r,smallLabelOffsetV:c}=a,h=Math.floor(l-2*f-2*i),u=Math.floor(o-c-r-I),m=Math.floor(h*-.5),S=e.x+m,j={top:e.y+c,left:S,position:"absolute",width:h,maxHeight:u,textAlign:"center"},b=["PWGx-pipeline-small-label"];return e.stage&&n(e.stage)&&b.push("selected"),t.jsx(E,{className:b.join(" "),style:j,children:e.text},e.key)}function se({details:e,layout:a}){const{nodeRadius:n}=a,l=e.text,o=e.y,f=e.x-Math.floor(n*2),i=1.35,r={top:o,left:f,lineHeight:i,marginTop:`-${i/2}em`,position:"absolute",maxWidth:F,overflow:"hidden",textOverflow:"ellipsis",background:"var(--card-background)",fontSize:"0.8125rem",fontWeight:"var(--font-bold-weight)",padding:"0 5px",whiteSpace:"nowrap"};return t.jsx(Z,{content:l,children:t.jsx("div",{style:r,children:l},e.key)})}function le(e){const{stages:a=[],layout:n,setStages:l,selectedStage:o,currentRunPath:f,previousRunPath:i,collapsed:r}=e,{run:c}=Q({currentRunPath:f,previousRunPath:i}),[h,u]=x.useState([]),[m,S]=x.useState([]),[d,j]=x.useState([]),[b,G]=x.useState([]),[y,L]=x.useState([]),[P,W]=x.useState(0),[k,M]=x.useState(0),[p,$]=x.useState({...T,...n}),[N,q]=x.useState(o);x.useEffect(()=>{c&&(C(c.stages),l&&l(c.stages))},[c]),x.useEffect(()=>{let s=!1,g=p;n!==e.layout&&(g={...T,...n},$(g),s=!0),o!==N&&q(o),a!==e.stages&&(s=!0),s&&C(a)},[n,o,a]);const C=(s=[])=>{const g=_(s,p,r??!1);u(g.nodeColumns),S(g.connections),j(g.bigLabels),G(g.smallLabels),L(g.branchLabels),W(g.measuredWidth),M(g.measuredHeight)},H=s=>N&&s&&N.id===s.id||!1,B=h.flatMap(s=>{var R;const g=((R=s.topStage)==null?void 0:R.state)??z.unknown;return s.rows.flatMap(V=>V.map(v=>(s.topStage&&"stage"in v&&v.stage&&Array.isArray(s.topStage.children)&&s.topStage.children.includes(v.stage)&&r&&(v.stage.state=g),v)))}),D={position:"relative",overflow:"visible"};return t.jsx("div",{className:"PWGx-PipelineGraph-container",children:t.jsxs("div",{style:D,className:"PWGx-PipelineGraph",children:[t.jsxs("svg",{width:P,height:k,children:[t.jsx(J,{connections:m,layout:p}),t.jsx(X,{layout:p,nodeColumns:h,isStageSelected:H})]}),B.map(s=>t.jsx(U,{node:s,collapsed:r},s.id)),d.map(s=>t.jsx(ee,{details:s,layout:p,measuredHeight:k,selectedStage:N,isStageSelected:H},s.key)),b.map(s=>t.jsx(te,{details:s,layout:p,isStageSelected:H},s.key)),y.map(s=>t.jsx(se,{details:s,layout:p},s.key))]})})}export{le as P};
//# sourceMappingURL=PipelineGraph-uS7S9Mxp.js.map
